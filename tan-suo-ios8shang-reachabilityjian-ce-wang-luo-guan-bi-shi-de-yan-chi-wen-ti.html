<!DOCTYPE html>
<html lang="zh"
>
<head>
    <title>探索iOS8上Reachability检测网络关闭时的延迟问题 - </title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://wngyongbin.github.io/blog/tan-suo-ios8shang-reachabilityjian-ce-wang-luo-guan-bi-shi-de-yan-chi-wen-ti.html">

        <meta name="author" content="王勇彬" />
        <meta name="keywords" content="iOS" />
        <meta name="description" content="本文主要探索下iOS8上Reachability检测网络关闭时的延迟问题，作者最后并没有解决该问题。 作者使用的Reachability版本 通过Pod安装的Reachability库可在Podfile.lock文件内查看版本号，作者使用的版本如下: - Reachability (3.2) Reachability在iOS7和iOS8上的延迟测试结果 首先呈上作者配置使用域名Reachability的代码: Reachability* reach = [Reachability reachabilityWithHostname:@&#34;xxx.xxx.com&#34;]; reach.reachableOnWWAN = YES; [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(reachabilityChanged:) name:kReachabilityChangedNotification object:nil]; [reach startNotifier]; reachabilityChanged:回调延迟的测试结果如下： 场景\系统版本 iOS7 iOS8 打开网络 回调基本无延迟 回调基本无延迟 关闭网络 回调基本无延迟 回调有几秒的延迟 开始寻找答案 进入Reachability头文件，查看有无注释？结果 ..." />

        <meta property="og:site_name" content="" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="探索iOS8上Reachability检测网络关闭时的延迟问题"/>
        <meta property="og:url" content="http://wngyongbin.github.io/blog/tan-suo-ios8shang-reachabilityjian-ce-wang-luo-guan-bi-shi-de-yan-chi-wen-ti.html"/>
        <meta property="og:description" content="本文主要探索下iOS8上Reachability检测网络关闭时的延迟问题，作者最后并没有解决该问题。 作者使用的Reachability版本 通过Pod安装的Reachability库可在Podfile.lock文件内查看版本号，作者使用的版本如下: - Reachability (3.2) Reachability在iOS7和iOS8上的延迟测试结果 首先呈上作者配置使用域名Reachability的代码: Reachability* reach = [Reachability reachabilityWithHostname:@&#34;xxx.xxx.com&#34;]; reach.reachableOnWWAN = YES; [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(reachabilityChanged:) name:kReachabilityChangedNotification object:nil]; [reach startNotifier]; reachabilityChanged:回调延迟的测试结果如下： 场景\系统版本 iOS7 iOS8 打开网络 回调基本无延迟 回调基本无延迟 关闭网络 回调基本无延迟 回调有几秒的延迟 开始寻找答案 进入Reachability头文件，查看有无注释？结果 ..."/>
        <meta property="article:published_time" content="2015-09-11" />
            <meta property="article:section" content="iOS" />
            <meta property="article:tag" content="iOS" />
            <meta property="article:author" content="王勇彬" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://wngyongbin.github.io/blog/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://wngyongbin.github.io/blog/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://wngyongbin.github.io/blog/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://wngyongbin.github.io/blog/theme/css/style.css" type="text/css"/>


</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://wngyongbin.github.io/blog/" class="navbar-brand">
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="http://wngyongbin.github.io/blog/category/ios.html">Ios</a>
                        </li>
                        <li >
                            <a href="http://wngyongbin.github.io/blog/category/markdown.html">Markdown</a>
                        </li>
                        <li >
                            <a href="http://wngyongbin.github.io/blog/category/qi-dian.html">起点</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://wngyongbin.github.io/blog/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://wngyongbin.github.io/blog/tan-suo-ios8shang-reachabilityjian-ce-wang-luo-guan-bi-shi-de-yan-chi-wen-ti.html"
                       rel="bookmark"
                       title="Permalink to 探索iOS8上Reachability检测网络关闭时的延迟问题">
                        探索iOS8上Reachability检测网络关闭时的延迟问题
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-09-11T13:00:00+08:00"> 五 11 九月 2015</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://wngyongbin.github.io/blog/tag/ios.html">iOS</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>本文主要探索下iOS8上Reachability检测网络关闭时的延迟问题，作者最后并没有解决该问题。</p>
<h2>作者使用的Reachability版本</h2>
<p>通过Pod安装的Reachability库可在Podfile.lock文件内查看版本号，作者使用的版本如下:  </p>
<div class="highlight"><pre>- Reachability (3.2)
</pre></div>


<h2>Reachability在iOS7和iOS8上的延迟测试结果</h2>
<p>首先呈上作者配置使用域名Reachability的代码:  </p>
<div class="highlight"><pre>    <span class="n">Reachability</span><span class="o">*</span> <span class="n">reach</span> <span class="o">=</span> <span class="p">[</span><span class="n">Reachability</span> <span class="nl">reachabilityWithHostname</span><span class="p">:</span><span class="s">@&quot;xxx.xxx.com&quot;</span><span class="p">];</span>
    <span class="n">reach</span><span class="p">.</span><span class="n">reachableOnWWAN</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>

    <span class="p">[[</span><span class="bp">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">addObserver</span><span class="p">:</span><span class="nb">self</span>
                                             <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">reachabilityChanged</span><span class="p">:)</span>
                                                 <span class="nl">name</span><span class="p">:</span><span class="n">kReachabilityChangedNotification</span>
                                               <span class="nl">object</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="p">[</span><span class="n">reach</span> <span class="n">startNotifier</span><span class="p">];</span>  
</pre></div>


<p>reachabilityChanged:回调延迟的测试结果如下：  </p>
<table>
<thead>
<tr>
<th align="center">场景\系统版本</th>
<th align="center">iOS7</th>
<th align="center">iOS8</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">打开网络</td>
<td align="center">回调基本无延迟</td>
<td align="center">回调基本无延迟</td>
</tr>
<tr>
<td align="center">关闭网络</td>
<td align="center">回调基本无延迟</td>
<td align="center">回调有几秒的延迟</td>
</tr>
</tbody>
</table>
<h2>开始寻找答案</h2>
<ul>
<li>进入Reachability头文件，查看有无注释？<strong>结果：没有发现</strong>  </li>
<li>前往Reachability的github页面，看看README.md文件和wiki上有无线索？<strong>结果：没有发现</strong>  </li>
<li>Google搜索'reachability delay'！也没有发现，不过在Apple的网站上找到了这个说明:  </li>
</ul>
<div class="highlight"><pre>  IMPORTANT: Reachability must use DNS to resolve the host name before 
  it can determine the Reachability of that host, and this may take time 
  on certain network connections. Because of this, the API will return 
  NotReachable until name resolution has completed. This delay may be 
  visible in the interface on some networks.  
</pre></div>


<p>答案似乎找到了~~</p>
<h2>尝试验证Apple的解释</h2>
<p>看看能不能通过抓包来做个验证，看看手机在断网之前会不会发出一些数据包。
详细的<a href="https://developer.apple.com/library/ios/qa/qa1176/_index.html">抓包教程见这里</a>，作者抱着侥幸的心理用rvictl抓了下包，关闭网络，可惜也没有发现数据包可以解释Apple对Reachability延时的解释  </p>
<h2>总结</h2>
<ul>
<li>不要过度信任Reachability;</li>
<li><strong>无论有没有网络，先把请求发出去，返回失败的时候再去检测是否有无网络</strong></li>
</ul>
<p>希望此篇文章对你有用；感谢阅读！</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'iosdevelop'; // required: replace example with your forum shortname

                    var disqus_identifier = 'tan-suo-ios8shang-reachabilityjian-ce-wang-luo-guan-bi-shi-de-yan-chi-wen-ti';
                var disqus_url = 'http://wngyongbin.github.io/blog/tan-suo-ios8shang-reachabilityjian-ce-wang-luo-guan-bi-shi-de-yan-chi-wen-ti.html';

            var disqus_config = function () {
                this.language = "zh";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="#"><i class="fa fa-you-can-add-links-in-your-config-file-square fa-lg"></i> You can add links in your config file</a></li>
                <li class="list-group-item"><a href="#"><i class="fa fa-another-social-link-square fa-lg"></i> Another social link</a></li>
              </ul>
            </li>



            <li class="list-group-item"><a href="http://wngyongbin.github.io/blog/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group " id="tags">
                </ul>
            </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 王勇彬
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://wngyongbin.github.io/blog/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://wngyongbin.github.io/blog/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://wngyongbin.github.io/blog/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'iosdevelop'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>